<%- include('../partials/header', { title: 'Llista de categories' }) %>

<div class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="display-6 fw-bold">ğŸ“‹ IncidÃ¨ncies pendents</h1>
    <a href="/actuacions" class="btn btn-outline-primary">Veure actuacions</a>
  </div>

  <div class="card shadow-sm rounded-4 border-0">
    <div class="card-body">
      <table class="table table-hover align-middle">
        <thead class="table-light text-uppercase text-muted small">
          <tr>
            <th>ID</th>
            <th>DescripciÃ³</th>
            <th>Tipus d'incidencia</th>
            <th>Departament</th>
            <th>TÃ¨cnic</th>
            <th>Prioritat
              <button class="btn btn-sm btn-link p-0 ms-1" onclick="ordenarPrioritat()">ğŸ”½</button>
            </th>
            <th>Estat</th>
            <th class="text-center">Accions</th>
          </tr>
        </thead>
        <tbody>
          <% incidencies.filter(incidencia => incidencia.estat === "No resolt").forEach(incidencia => { %>
            <tr>
              <td class="fw-semibold"><%= incidencia.id %></td>
              <td><%= incidencia.descripcio %></td>
              <td><%= incidencia.Tipu.nom_tipus %></td>
              <td><%= incidencia.Departament.nom_dpt %></td>
              <td><%= incidencia.Tecnic && incidencia.Tecnic.nom ? incidencia.Tecnic.nom : 'Sin assignar' %></td>
              <td>
                <% if (incidencia.prioritat === 'Alta') { %>
                  <span class="badge bg-danger">Alta</span>
                <% } else if (incidencia.prioritat === 'Mitjana') { %>
                  <span class="badge bg-warning text-dark">Mitjana</span>
                <% } else { %>
                  <span class="badge bg-success">Baixa</span>
                <% } %>
              </td>
              <td><span class="badge bg-secondary"><%= incidencia.estat %></span></td>
              <td class="text-center">
                <a href="/incidencies/<%= incidencia.id %>/edit" class="btn btn-sm btn-outline-warning me-1">âœï¸</a>
                <a href="/incidencies/<%= incidencia.id %>/delete" class="btn btn-sm btn-outline-danger" onclick="return confirm('EstÃ s segur que vols eliminar aquesta incidÃ¨ncia?');">ğŸ—‘ï¸</a>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>

  <div class="text-center mt-4">
    <button class="btn btn-danger" onclick="resetAccess()">ğŸšª Tancar sessiÃ³</button>
  </div>
</div>

<script>
  function disableHeaderLinks() {
    document.getElementById("projecte-link").style.pointerEvents = "none";
    document.getElementById("incidencies-link").style.pointerEvents = "none";
  }

  function resetAccess() {
    sessionStorage.removeItem("accessGranted");
    window.location.href = "/";
  }
</script>


<script>
  let ordreAscendent = true;

  function ordenarPrioritat() {
    const files = Array.from(document.querySelectorAll('tbody tr'));
    
    files.sort((a, b) => {
      const valorA = a.querySelector('td:nth-child(6)').innerText.trim();
      const valorB = b.querySelector('td:nth-child(6)').innerText.trim();

      const prioritats = { 'Alta': 3, 'Mitjana': 2, 'Baixa': 1 };

      const comparacio = prioritats[valorA] - prioritats[valorB];
      return ordreAscendent ? comparacio : -comparacio;
    });

    const tbody = document.querySelector('tbody');
    files.forEach(fila => tbody.appendChild(fila));

    ordreAscendent = !ordreAscendent;
  }
</script>

<%- include('../partials/footer') %>
